project: testcraft

path: /testcraft
environment:
  PROJECT_PATH: /testcraft
  PATH: /snap/bin:$PATH

include:
  - tests/spread

backends:
  # lxd:  # Disabled due to https://github.com/canonical/spread/issues/215
  #   systems:
  #     - ubuntu-24.04
  lxd: # Copied and modified from chisel-releases
    type: adhoc
    allocate: |
      set -x

      mkdir -p $HOME/.spread
      export counter_file="$HOME/.spread/multipass-count"
      instance_num=$(flock -x $counter_file bash -c '
        [ -s $counter_file ] || echo 0 > $counter_file
        num=$(< $counter_file)
        echo $num
        echo $(( $num + 1 )) > $counter_file')

      instance_name=${SPREAD_SYSTEM}-${instance_num}

      release=$(echo $SPREAD_SYSTEM | awk -F '-' '{print $2}')

      # Ideally, we would add the ubuntu-minimal remote
      # e.g. https://cloud-images.ubuntu.com/minimal/releases/jammy/
      # but that would effectively change the host's LXC configurations.

      echo "Allocating ${instance_name}..."
      lxc launch --ephemeral ubuntu-daily:$release ${instance_name}
      until lxc exec ${instance_name} -- systemctl status | grep "running"
      do
        sleep 5
      done
      lxc exec ${instance_name} -- systemctl enable --now ssh
      lxc exec ${instance_name} -- sed -i 's/^\s*#\?\s*\(PermitRootLogin\|PasswordAuthentication\)\>.*/\1 yes/' /etc/ssh/sshd_config
      lxc exec ${instance_name} -- bash -c "sed -i 's/^\s*\(PermitRootLogin\|PasswordAuthentication\)\>.*/# COMMENTED OUT BY SPREAD: \0/' /etc/ssh/sshd_config.d/* || true"
      lxc exec ${instance_name} -- bash -c "test -d /etc/ssh/sshd_config.d && echo -e 'PermitRootLogin=yes\nPasswordAuthentication=yes' > /etc/ssh/sshd_config.d/00-spread.conf"
      lxc exec ${instance_name} -- bash -c "echo 'root:${SPREAD_PASSWORD}' | chpasswd"
      lxc exec ${instance_name} -- killall -HUP sshd
      ADDRESS `lxc list --format=json ${instance_name} | jq -r '.[0].state.network.eth0.addresses[] | select(.family=="inet") | .address'`
    discard: |
      instance_name=$(lxc list --format csv | grep $SPREAD_SYSTEM_ADDRESS | cut -f1 -d\,)
      lxc stop $instance_name || true
    systems:
      - ubuntu-noble:

prepare: |
  snap wait system seed.loaded
  snap install snapd || snap refresh snapd
  snap wait system seed.loaded

  snap install --dangerous --classic tests/spread/*.snap

suites:
  tests/spread/testcraft/:
    summary: Tests for testcraft core functionality
