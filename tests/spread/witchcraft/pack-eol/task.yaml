summary: test witchcraft packing on an EOL base.

systems:
  - -ubuntu-20.04-64 # Overlay step freezes forever.

prepare: |
  sudo apt-get --yes install faketime

  # Change to the current base
  . /etc/os-release
  sed -i "s/base: REPLACE_THIS/base: ubuntu@${VERSION_ID}/" witchcraft.yaml

execute: |
  # We didn't support any bases this far in the past.
  faketime '1994-04-27' witchcraft pack |& MATCH "Cannot pack cauldron. Base '[a-z0-9.@]+' has reached end-of-life."
  faketime '1994-04-27' witchcraft pack --destructive-mode |& MATCH "Cannot pack cauldron. Base '[a-z0-9.@]+' has reached end-of-life."

  # Pack the day after the base goes EOL
  . /etc/os-release
  EOL_DATE=$(cat /usr/share/distro-info/ubuntu.csv | awk -F, '$3=="'$VERSION_CODENAME'" {print $6}')
  faketime "$(date -d "${EOL_DATE} + 1 day" -I -u)" witchcraft pack |& MATCH "Cannot pack cauldron. Base '[a-z0-9.@]+' has reached end-of-life."
  faketime "$(date -d "${EOL_DATE} + 1 day" -I -u)" witchcraft pack --destructive-mode |& MATCH "Cannot pack cauldron. Base '[a-z0-9.@]+' has reached end-of-life."

  set -o pipefail
  # Try packing the day it EOLs:
  faketime "${EOL_DATE}" witchcraft pack --destructive-mode |& tee pack.log
  MATCH "Using base '[a-z0-9.@]+', which will enter end-of-life on ${EOL_DATE}." pack.log
  set +o pipefail

  # Packing on an unsupported base is our last, best hope for peace.
  faketime '2256-03-09' witchcraft pack |& MATCH "Base '[a-z0-9.@]+' has reached"
  faketime '2256-03-09' witchcraft pack --destructive-mode |& MATCH "Base '[a-z0-9.@]+' has reached"

  faketime '2256-03-09' witchcraft pack --ignore=unmaintained --destructive-mode

  if [[ $(find . -maxdepth 1 -name '*.witchcraft') == "" ]]; then
    echo "No witchcraft file created" >> /dev/stderr
    exit 1
  fi

restore: |
  rm -f *.witchcraft
